<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Customers</title>

    <style>
      .topbar {
        margin: 10px;
        padding-top: 20px;
      }
      .topbar label {
        margin-left: 30px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
      }
      .customer-card {
        border: 1px solid #ccc;
        padding: 10px;
        margin: 10px;
        border-radius: 8px;
        cursor: pointer;
      }
      .pagination {
        display: flex;
        justify-content: center;
      }
      .pagination a {
        color: black;
        float: left;
        padding: 8px 16px;
        text-decoration: none;
        transition: background-color 0.3s;
      }

      .pagination a.disabled {
        pointer-events: none;
        opacity: 0.5;
      }

      /* Style the active/current link */
      .pagination a.active {
        background-color: dodgerblue;
        color: white;
      }
      /* Add a grey background color on mouse-over */
      .pagination a:hover:not(.active) {
        background-color: #ddd;
      }

      .customerCreateBtn {
        display: flex;
        flex-direction: column;
        float: right;
      }
      /* Customer Registration */
      /* Modal background */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        overflow: auto;
      }

      /* Model content box */
      .model-content {
        background-color: #fff;
        margin: 50px auto;
        padding: 30px;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      /* Close button */
      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close:hover {
        color: #000;
      }

      /* Form groups */
      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #4caf50;
      }

      /* Buttons */
      .add-customer-btn {
        background-color: #4caf50;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        margin-bottom: 20px;
      }

      .add-customer-btn:hover {
        background-color: #45a049;
      }

      .form-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .submit-btn {
        flex: 1;
        background-color: #4caf50;
        color: white;
        padding: 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      }

      .submit-btn:hover {
        background-color: #45a049;
      }

      .cancel-btn {
        flex: 1;
        background-color: #f44336;
        color: white;
        padding: 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      }

      .cancel-btn:hover {
        background-color: #da190b;
      }

      /* Messages */
      .form-message {
        margin-top: 15px;
        padding: 10px;
        border-radius: 4px;
        display: none;
      }

      .form-message.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
        display: block;
      }

      .form-message.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="topbar">
      <input type="search" id="customerSearch" />
      <button id="searchBtn" type="button">Search</button>

      <label for="limit">Limit:</label>
      <select id="limit">
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="30">30</option>
        <option value="40">40</option>
      </select>
    </div>

    <button id="addCustomerBtn" class="add-customer-btn">Add Customer</button>

    <!-- Button to open pop-up-->
    <div id="customerModal" class="modal">
      <div class="model-content">
        <span class="close">&times;</span>
        <h2>Customer Registration</h2>

        <form id="addCustomerForm">
          <!-- Required Form Fields -->
          <div class="form-group">
            <label for="first_name">First Name *</label>
            <input type="text" name="first_name" id="first_name" required />
          </div>
          <div class="form-group">
            <label for="last_name">Last Name *</label>
            <input type="text" name="last_name" id="last_name" required />
          </div>
          <div class="form-group">
            <label for="email">Email *</label>
            <input type="email" name="email" id="email" required />
          </div>
          <div class="form-group">
            <label for="address"> Street Address * </label>
            <input type="text" id="address" name="address" required />
          </div>

          <div class="form-group">
            <label for="district">District</label>
            <input type="text" id="district" name="district" />
          </div>

          <div class="form-group">
            <label for="city">City *</label>
            <input type="text" id="city" name="city" required />
          </div>

          <div class="form-group">
            <label for="country">Country *</label>
            <input type="text" id="country" name="country" required />
          </div>

          <div class="form-group">
            <label for="postal_code">Postal Code</label>
            <input type="text" id="postal_code" name="postal_code" />
          </div>

          <div class="form-group">
            <label for="phone">Phone</label>
            <input type="tel" id="phone" name="phone" />
          </div>
          <div class="form-group">
            <label for="store_id">Store *</label>
            <select id="store_id" name="store_id" required>
              <option value="">Select a store</option>
              <!-- Will be populated dynamically -->
            </select>
          </div>
          <div class="form-actions">
            <button type="button" class="cancel-btn">Cancel</button>
            <button type="submit" class="submit-btn">Add Customer</button>
          </div>
        </form>

        <div id="formMessage" class="form-message"></div>
      </div>
    </div>
    <!-- Customers -->
    <div id="customers" class="grid"></div>

    <!-- Pagination -->
    <div id="pageInfo"></div>
    <div class="pagination" id="pagination"></div>

    <script>
      /*  
      1- Break the URL into params and assign them to variable
      2- Build URL 
      3- Load customer data (Api)
      4- When search button is clicked or limit changed, do step 3 again. 
      */
      let page = 1;
      function buildURL() {
        // Fetch the text from search input
        const q = document.getElementById("customerSearch").value.trim();
        // Fetch the limit of customers shown in the page
        const limit = document.getElementById("limit").value;

        const url = new URL("/api/customers", window.location.origin);
        console.log(url);

        // Set the parameters to API endpoint
        url.searchParams.set("limit", String(limit));
        url.searchParams.set("page", String(page));

        if (q) {
          url.searchParams.set("q", q);
        }
        return url;
      }

      function makePageLink(
        label,
        targetPage,
        { active = false, disabled = false } = {}
      ) {
        const a = document.createElement("a");
        a.href = "#";
        a.textContent = label;

        if (active) a.classList.add("active");
        if (disabled) a.classList.add("disabled");

        a.dataset.page = String(targetPage);
        return a;
      }
      function renderPagination() {
        const pag = document.getElementById("pagination");
        pag.innerHTML = "";

        pag.appendChild(makePageLink("<<", page - 1, { disabled: page <= 1 }));

        const windowSize = 5;
        let start = Math.max(1, page - Math.floor(windowSize / 2));

        let end = Math.min(pages, start + windowSize - 1);
        start = Math.max(1, end - windowSize + 1);

        for (let p = start; p <= end; p++) {
          pag.appendChild(makePageLink(String(p), p, { active: p === page }));
        }
        // Next
        pag.appendChild(
          makePageLink("Â»", page + 1, { disabled: page >= pages })
        );
      }

      async function loadCustomers() {
        const url = buildURL();

        const resp = await fetch(url);
        const data = await resp.json();
        console.log(data);

        // update pagination state from backend
        pages = data.pages || 1;
        if (page > pages) page = pages;

        document.getElementById("pageInfo").textContent =
          `Page ${page}/${pages}-Total: ${data.total ?? 0}`;
        console.log(data);

        // Load the customers
        const customers = data.items;

        const customersDiv = document.getElementById("customers");
        customersDiv.innerHTML = "";

        customers.forEach((customer) => {
          const card = document.createElement("div");
          card.className = "customer-card";

          customerHTML = `
            <h1>${customer.first_name} ${customer.last_name}</h1>
            <p>Id: ${customer.customer_id}</p>
            <p>Email: ${customer.email.toLowerCase()}</p>
            <p>District: ${customer.district}</p>
            <p>City: ${customer.city}</p>
            <p>Country: ${customer.country}</p>
            <p>Addres: ${customer.address}</p>
          `;
          card.innerHTML = customerHTML;

          customersDiv.appendChild(card);
        });
        renderPagination();
      }
      document.getElementById("pagination").addEventListener("click", (e) => {
        const a = e.target.closest("a");
        if (!a) return;
        e.preventDefault();

        if (a.classList.contains("disabled")) return;

        const nextPage = parseInt(a.dataset.page, 10);
        if (!Number.isFinite(nextPage)) return;
        if (nextPage < 1 || nextPage > pages) return;

        page = nextPage;
        loadCustomers();
      });

      // Reset to page 1 when filters change
      document.getElementById("limit").addEventListener("change", () => {
        page = 1;
        loadCustomers();
      });

      document.getElementById("searchBtn").addEventListener("click", () => {
        page = 1;
        loadCustomers();
      });

      document
        .getElementById("customerSearch")
        .addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            page = 1;
            loadCustomers();
          }
        });

      loadCustomers();

      /* Customer Registration */
      // Get modal elements
      const modal = document.getElementById("customerModal");
      const addBtn = document.getElementById("addCustomerBtn");
      const closeBtn = document.querySelector(".close");
      const cancelBtn = document.querySelector(".cancel-btn");
      const form = document.getElementById("addCustomerForm");
      const formMessage = document.getElementById("formMessage");

      // Open modal
      addBtn.onclick = function () {
        modal.style.display = "block";
        loadStores(); // Load stores into dropdown
      };

      // Close modal
      closeBtn.onclick = function () {
        modal.style.display = "none";
        form.reset();
        formMessage.style.display = "none";
      };

      cancelBtn.onclick = function () {
        modal.style.display = "none";
        form.reset();
        formMessage.style.display = "none";
      };

      // Close modal when clicking outside
      window.onclick = function (event) {
        if (event.target == modal) {
          modal.style.display = "none";
          form.reset();
          formMessage.style.display = "none";
        }
      };

      // Load stores into dropdown
      async function loadStores() {
        try {
          const response = await fetch("http://localhost:3000/api/stores");
          const stores = await response.json();

          const select = document.getElementById("store_id");
          select.innerHTML = '<option value="">Select a store</option>';

          stores.forEach((store) => {
            const option = document.createElement("option");
            option.value = store.store_id;
            option.textContent = `${store.address}, ${store.city}, ${store.country}`;
            select.appendChild(option);
          });
        } catch (error) {
          console.error("Error loading stores:", error);
        }
      }

      // Handle form submission
      form.onsubmit = async function (e) {
        e.preventDefault();

        // Get form data
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);

        // Convert store_id to number
        data.store_id = parseInt(data.store_id);

        try {
          const response = await fetch("http://localhost:3000/api/customers", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          });

          const result = await response.json();

          if (response.ok) {
            // Success!
            formMessage.className = "form-message success";
            formMessage.textContent = "Customer added successfully!";
            formMessage.style.display = "block";

            // Reset form
            form.reset();

            // Refresh customer list (you'll need to implement this)
            setTimeout(() => {
              modal.style.display = "none";
              formMessage.style.display = "none";
              location.reload(); // Or call your fetchCustomers() function
            }, 2000);
          } else {
            // Error from server
            formMessage.className = "form-message error";
            formMessage.textContent = result.error || "Failed to add customer";
            formMessage.style.display = "block";
          }
        } catch (error) {
          console.error("Error:", error);
          formMessage.className = "form-message error";
          formMessage.textContent = "Network error. Please try again.";
          formMessage.style.display = "block";
        }
      };
    </script>
  </body>
</html>
